name: Run Password Generator

on:
  workflow_dispatch:
    inputs:
      length:
        description: 'Password length (min 14)'
        required: true
        default: '14'
      save:
        description: 'Save to file? (yes/no)'
        required: true
        default: 'no'

jobs:
  sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Bandit
        run: pip install bandit
        
      - name: Run Bandit SAST
        run: bandit -r .

  unit-test:
    needs: sast
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install coverage
      
      - name: Run test with coverage
        run: coverage run -m unittest test_main.py

      - name: Report coverage
        run: coverage report

      - name: Generate HTML coverage report
        run: coverage html
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov/


  generate-password:
    needs: unit-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run password generator
        run: |
          LENGTH="${{ github.event.inputs.length }}"
          SAVE="${{ github.event.inputs.save }}"

          if [ "$SAVE" = "yes" ]; then
            python main.py --length "$LENGTH" --save yes
          else
            python main.py --length "$LENGTH"
          fi

      - name: Upload Password File
        if: ${{ github.event.inputs.save == 'yes' }}
        uses: actions/upload-artifact@v4
        with:
          name: generated-password
          path: .password.txt
          include-hidden-files: true